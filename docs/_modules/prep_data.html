

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>prep_data &#8212; Huff &amp; Puff &amp; Classify  documentation</title>
    <link rel="stylesheet" href="../_static/dotted.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
  </head><body>
        <div class="header">
          <div class="header-top">
            <h1 class="heading"><a href="../index.html">
              <span>Huff &amp; Puff &amp; Classify  documentation</span></a></h1>
            <h2 class="heading"><span>prep_data</span></a></h2>
          </div>
          <div class="topnav">
            
        <p>
        <a class="uplink" href="../index.html">Contents</a>
        </p>

            <div class="globaltoc">
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../project.html">Project Summary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../software_components.html">Software Components</a></li>
<li class="toctree-l1"><a class="reference internal" href="../code.html">Code Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../demo.html">Demo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../environment.html">Environment and Data Acquisition</a></li>
</ul>

            </div>
          </div>
        </div>
        <div class="wrapper">

          <div class="document">
            <div class="documentwrapper">
              <div class="bodywrapper">
                <div class="body">
                  
  <h1>Source code for prep_data</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">timeit</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>


<span class="c1"># define necessary helper functions</span>
<div class="viewcode-block" id="clean_text"><a class="viewcode-back" href="../code.html#prep_data.clean_text">[docs]</a><span class="k">def</span> <span class="nf">clean_text</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function is used to clean a selection of text.</span>
<span class="sd">    It uses several regular expressions and built in text commands in order to remove commonly seen</span>
<span class="sd">    errors,</span>
<span class="sd">    nonsense values,</span>
<span class="sd">    punctuation,</span>
<span class="sd">    digits, and</span>
<span class="sd">    extra whitespace.</span>
<span class="sd">    TODO: Add functionality to impute a selected value for NaN or missing values?</span>

<span class="sd">    :param text: This is a text value that needs to be cleaned.</span>

<span class="sd">    :return: text: This function returns a cleaned version of the input text.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># import necessary modules</span>
    <span class="kn">import</span> <span class="nn">re</span>

    <span class="c1"># force all vals in series to string</span>
    <span class="n">text</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

    <span class="c1"># first remove uppercase</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="c1"># remove common errors</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\[.]&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\&lt;ff&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\&lt;fb&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\&lt;a\d&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\&lt;c\d&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\&lt;d\d&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\&lt;e\d&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\&lt;f\d&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\d+\.&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>

    <span class="c1"># remove the characters [\], [&#39;] and [&quot;]</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>

    <span class="c1"># replace punctuation characters with spaces</span>
    <span class="n">filters</span> <span class="o">=</span> <span class="s1">&#39;!&quot;</span><span class="se">\&#39;</span><span class="s1">#$%&amp;()*+,-./:;&lt;=&gt;?@[</span><span class="se">\\</span><span class="s1">]^_`{|}~</span><span class="se">\t\n</span><span class="s1">&#39;</span>
    <span class="n">translate_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">)</span>
    <span class="n">translate_map</span> <span class="o">=</span> <span class="nb">str</span><span class="o">.</span><span class="n">maketrans</span><span class="p">(</span><span class="n">translate_dict</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">translate_map</span><span class="p">)</span>

    <span class="c1"># remove any remaining digit codes</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\d+&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>

    <span class="c1"># remove any leading/trailing/duplicate whitespace</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39; +&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>

    <span class="k">return</span> <span class="n">text</span></div>


<span class="c1"># define master function</span>
<div class="viewcode-block" id="read_then_clean"><a class="viewcode-back" href="../code.html#prep_data.read_then_clean">[docs]</a><span class="k">def</span> <span class="nf">read_then_clean</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">vars_to_clean</span><span class="p">,</span> <span class="n">filter_series</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This is the master function for this module. It uses the previously defined helper functions,</span>
<span class="sd">    in order to output a clean dataset for user. It reads in a selected .csv file from a given filepath,</span>
<span class="sd">    and applies the previously defined cleaning functions to a list of variables provided by user.</span>

<span class="sd">    It can also optionally filter the df based on the survey series or TODO language.</span>

<span class="sd">    :param file_path: This is a string indicating which file that you want to read in.</span>
<span class="sd">    :param vars_to_clean: This is a list of strings that indicate which columns you want to clean.</span>
<span class="sd">    :param filter_series: This is a list of strings that indicate which survey series to keep.</span>

<span class="sd">    :return: df_clean: This is a pandas df that has columns of text values that have been cleaned using the helper</span>
<span class="sd">        function.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># import necessary modules</span>
    <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

    <span class="c1"># read in your data</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;~begin reading&quot;</span><span class="p">)</span>
    <span class="n">df_raw</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">low_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">min_nrow</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_raw</span><span class="p">)</span>  <span class="c1"># save the row count to test after cleaning and verify that rows are not being dropped</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;data read!&quot;</span><span class="p">)</span>

    <span class="c1"># cleanup</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;~begin cleaning&quot;</span><span class="p">)</span>
    <span class="n">df_clean</span> <span class="o">=</span> <span class="n">df_raw</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">vars_to_clean</span><span class="p">:</span>
        <span class="n">df_clean</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_clean</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">clean_text</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;data clean!&quot;</span><span class="p">)</span>

    <span class="c1"># Verify that the minimum rowcount continues to be met</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_clean</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">min_nrow</span><span class="p">:</span>
        <span class="k">class</span> <span class="nc">RowCountException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Custom exception class.</span>
<span class="sd">            </span>
<span class="sd">            This exception is raised when the minimum row is unmet.</span>

<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">pass</span>

        <span class="k">raise</span> <span class="n">RowCountException</span><span class="p">(</span><span class="s2">&quot;Minimum number of rows were not returned after cleaning. Data is being lost!&quot;</span><span class="p">)</span>

    <span class="c1"># Filter data if filter arguments are provided by user</span>
    <span class="k">if</span> <span class="n">filter_series</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;~applying filter&quot;</span><span class="p">)</span>
        <span class="n">df_clean</span> <span class="o">=</span> <span class="n">df_clean</span><span class="p">[</span><span class="n">df_clean</span><span class="p">[</span><span class="s1">&#39;survey_series&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">filter_series</span><span class="p">)]</span>

    <span class="c1"># output a clean dataset</span>
    <span class="k">return</span> <span class="n">df_clean</span></div>


<span class="c1"># define function to replace meaningless values with NaNs</span>
<div class="viewcode-block" id="remove_garbage_codes"><a class="viewcode-back" href="../code.html#prep_data.remove_garbage_codes">[docs]</a><span class="k">def</span> <span class="nf">remove_garbage_codes</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">vars_to_clean</span><span class="p">,</span> <span class="n">garbage_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This helper function is used to remove garbage values from a pandas df, replacing them with NaN.</span>
<span class="sd">    TODO: ?</span>

<span class="sd">    :param df: This is a pandas df that has columns with garbage values to be removed.</span>
<span class="sd">    :param vars_to_clean: This is a list of strings that indicate which columns you want to clean.</span>
<span class="sd">    :param garbage_list: This is a list of strings that indicate which garbage values to replace with NaN</span>

<span class="sd">    :return: df_clean: This function returns a pandas df where the garbage codes have been replaced with NaN.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># import necessary modules</span>
    <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

    <span class="n">df_clean</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># build dictionary to map all garbage values to NaN</span>
    <span class="n">garb_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">string</span> <span class="ow">in</span> <span class="n">garbage_list</span><span class="p">:</span>
        <span class="n">garb_dict</span><span class="p">[</span><span class="n">string</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">garb_dict</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">vars_to_clean</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;removing garbage from &quot;</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span>
        <span class="n">df_clean</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">garb_dict</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># output a clean dataset</span>
    <span class="k">return</span> <span class="n">df_clean</span></div>


<span class="c1"># define function to replace meaningless values with NaNs</span>
<div class="viewcode-block" id="extract_ranking"><a class="viewcode-back" href="../code.html#prep_data.extract_ranking">[docs]</a><span class="k">def</span> <span class="nf">extract_ranking</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">vars_to_clean</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This helper function is used to extract the ordinal rankings from numerical coding.</span>
<span class="sd">    TODO: ?</span>

<span class="sd">    :param df: This is a pandas df that has columns with garbage values to be removed.</span>
<span class="sd">    :param vars_to_clean: This is a list of strings that indicate which columns you want to extract ranks from.</span>
<span class="sd">    :return: df_out: This function returns a pandas df with new vars added with the ordinal rank cols defined.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># import necessary modules</span>
    <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
    <span class="kn">import</span> <span class="nn">re</span>

    <span class="n">df_out</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">vars_to_clean</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;defining ranking for &quot;</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span>
        <span class="n">newcol</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;_num&quot;</span><span class="p">,</span> <span class="s2">&quot;_rank&quot;</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span>
        <span class="n">df_out</span><span class="p">[</span><span class="n">newcol</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_out</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># output a clean dataset</span>
    <span class="k">return</span> <span class="n">df_out</span></div>


<div class="viewcode-block" id="load_data"><a class="viewcode-back" href="../code.html#prep_data.load_data">[docs]</a><span class="k">def</span> <span class="nf">load_data</span><span class="p">(</span><span class="n">file_name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This helper function is used to load a dataset from a selected csv file.</span>
<span class="sd">    It monitors the runtime of the loading process and also truncates the dataset</span>
<span class="sd">    to six specified columns as the training attributes. values with 0 within the numbers</span>
<span class="sd">    of roof, wall, floor are filtered out as well as rows containing nan.</span>

<span class="sd">    :param file_name: This is the file name of the csv file to load in for processing</span>
<span class="sd">    :return: df: This function returns a dataframe with specified columns and no missing data</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># define start time</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">timeit</span><span class="o">.</span><span class="n">default_timer</span><span class="p">()</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">low_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="c1"># truncate process if the dataframe to specified columns and remove missing data</span>
    <span class="n">attr</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;int_year&#39;</span><span class="p">,</span>
            <span class="s1">&#39;housing_roof_num&#39;</span><span class="p">,</span> <span class="s1">&#39;housing_wall_num&#39;</span><span class="p">,</span> <span class="s1">&#39;housing_floor_num&#39;</span><span class="p">,</span> <span class="s1">&#39;iso3&#39;</span><span class="p">]</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;housing_wall_num&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;housing_roof_num&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;housing_floor_num&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

    <span class="c1"># define end time</span>
    <span class="n">stop</span> <span class="o">=</span> <span class="n">timeit</span><span class="o">.</span><span class="n">default_timer</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Runtime:</span><span class="si">{:.2f}</span><span class="s2"> sec&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stop</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="cleaning_block"><a class="viewcode-back" href="../code.html#prep_data.cleaning_block">[docs]</a><span class="k">def</span> <span class="nf">cleaning_block</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">word</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This helper function filters out special characters within number columns, and convert numbers from str to int.</span>

<span class="sd">    :param df: This is a dataframe that is read in and manipulated to clean out special characters &#39;.&#39; and &#39;?&#39; within</span>
<span class="sd">        the number columns and covert the data type of the numbers from string to integer</span>
<span class="sd">    :param word:</span>

<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;housing_&#39;</span> <span class="o">+</span> <span class="n">word</span> <span class="o">+</span> <span class="s1">&#39;_num&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;housing_&#39;</span> <span class="o">+</span> <span class="n">word</span> <span class="o">+</span> <span class="s1">&#39;_num&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;housing_&#39;</span> <span class="o">+</span> <span class="n">word</span> <span class="o">+</span> <span class="s1">&#39;_num&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;housing_&#39;</span> <span class="o">+</span> <span class="n">word</span> <span class="o">+</span> <span class="s1">&#39;_num&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;housing_&#39;</span> <span class="o">+</span> <span class="n">word</span> <span class="o">+</span> <span class="s1">&#39;_num&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;housing_&#39;</span> <span class="o">+</span> <span class="n">word</span> <span class="o">+</span> <span class="s1">&#39;_num&#39;</span><span class="p">])</span></div>


<div class="viewcode-block" id="ranking"><a class="viewcode-back" href="../code.html#prep_data.ranking">[docs]</a><span class="k">def</span> <span class="nf">ranking</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">vals</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This helper function ranks the _num columns by the digit in tens, excluding the numbers smaller than 10</span>
<span class="sd">    or greater than 35, which are considered as invalid or missing values.</span>

<span class="sd">    :param df: This is a dataframe read to be ranked.</span>
<span class="sd">    :param vals: This is a list of category names (eg. roof, wall, floor) that is specified to be ranked.</span>
<span class="sd">    :return: df: This function returns a pandas df with the ordinal rank cols added to the read in datafame.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">vals</span><span class="p">:</span>
        <span class="n">cleaning_block</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;housing_&#39;</span> <span class="o">+</span> <span class="n">val</span> <span class="o">+</span> <span class="s1">&#39;_num&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">35</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;housing_&#39;</span> <span class="o">+</span> <span class="n">val</span> <span class="o">+</span> <span class="s1">&#39;_num&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">)]</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">val</span> <span class="o">+</span> <span class="s1">&#39;_rank&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;housing_&#39;</span> <span class="o">+</span> <span class="n">val</span> <span class="o">+</span> <span class="s1">&#39;_num&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">val</span> <span class="o">+</span> <span class="s1">&#39;_rank&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">val</span> <span class="o">+</span> <span class="s1">&#39;_rank&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">val</span> <span class="o">+</span> <span class="s1">&#39;_rank&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">val</span> <span class="o">+</span> <span class="s1">&#39;_rank&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="extract_features"><a class="viewcode-back" href="../code.html#prep_data.extract_features">[docs]</a><span class="k">def</span> <span class="nf">extract_features</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">LABEL</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This is a helper function that produces a list of features used for model training.</span>

<span class="sd">    :param df: This is a dataframe read in for feature extraction.</span>
<span class="sd">    :param LABEL: This is the label specified under prediction.</span>

<span class="sd">    :return: features : This is a list of features with label(answers) columns dropped.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># list features</span>
    <span class="n">features</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="n">features</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;housing_&#39;</span> <span class="o">+</span> <span class="n">LABEL</span> <span class="o">+</span> <span class="s1">&#39;_num&#39;</span><span class="p">)</span>
    <span class="n">features</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">LABEL</span> <span class="o">+</span> <span class="s1">&#39;_rank&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">features</span></div>


<div class="viewcode-block" id="shuffle_redistribute"><a class="viewcode-back" href="../code.html#prep_data.shuffle_redistribute">[docs]</a><span class="k">def</span> <span class="nf">shuffle_redistribute</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">LABEL</span><span class="p">,</span> <span class="n">Redistribute</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This helper function generalizes the distribution of the data set with respect to the three ranks (1,2,3),</span>
<span class="sd">    then it shuffles the data set to unbiased.</span>

<span class="sd">    :param df: This is a dtaframe read in to shuffle and redistribute</span>
<span class="sd">    :param LABEL: This is the label specified under prediction</span>
<span class="sd">    :param Redistribute: set True for data redistribution (default True)</span>

<span class="sd">    :return:</span>
<span class="sd">        df (pandas df): Returns the modified dataframe</span>
<span class="sd">        rank_dist: This is a list of the number of data within each rank(1,2,3)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">Redistribute</span><span class="p">:</span>
        <span class="c1"># split the dataframe to three subsets grouped by rank 1,2,3,</span>
        <span class="n">rank1</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">LABEL</span> <span class="o">+</span> <span class="s1">&#39;_rank&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">rank2</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">LABEL</span> <span class="o">+</span> <span class="s1">&#39;_rank&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">]</span>
        <span class="n">rank3</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">LABEL</span> <span class="o">+</span> <span class="s1">&#39;_rank&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">]</span>

        <span class="n">list_for_rank_df</span> <span class="o">=</span> <span class="p">[</span><span class="n">rank1</span><span class="p">,</span> <span class="n">rank2</span><span class="p">,</span> <span class="n">rank3</span><span class="p">]</span>
        <span class="n">new_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># determine the smallest dataframe grouped by rank 1,2,3</span>
        <span class="n">base</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rank1</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">rank2</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">rank3</span><span class="p">))</span>

        <span class="c1"># redistribution procees by dividing the portion based on the smallest dataset</span>
        <span class="k">for</span> <span class="n">rank</span> <span class="ow">in</span> <span class="n">list_for_rank_df</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rank</span><span class="p">)</span> <span class="o">!=</span> <span class="n">base</span><span class="p">:</span>
                <span class="n">rank</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;rand_num&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">rank</span><span class="p">))</span>
                <span class="n">rank</span> <span class="o">=</span> <span class="n">rank</span><span class="p">[</span><span class="n">rank</span><span class="p">[</span><span class="s1">&#39;rand_num&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">base</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">rank</span><span class="p">)]</span>
                <span class="n">rank</span> <span class="o">=</span> <span class="n">rank</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;rand_num&#39;</span><span class="p">)</span>
            <span class="n">new_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rank</span><span class="p">)</span>
        <span class="c1"># concat the three sub dataframes</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">new_list</span><span class="p">)</span>
    <span class="c1"># count the total amount of data of each rank 1,2,3</span>
    <span class="n">rank_dist</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">LABEL</span> <span class="o">+</span> <span class="s1">&#39;_rank&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="c1"># randomly shuffle the rows of the overall dataframe</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">frac</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span><span class="p">,</span> <span class="n">rank_dist</span></div>


<div class="viewcode-block" id="train_test_split"><a class="viewcode-back" href="../code.html#prep_data.train_test_split">[docs]</a><span class="k">def</span> <span class="nf">train_test_split</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">LABEL</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function splits the dataframe to random testing and training set with 75% and 25%each.</span>

<span class="sd">    :param df: This is the dataframe to be split</span>
<span class="sd">    :param features: This is the list of specified features</span>
<span class="sd">    :param LABEL: This is the label specified under prediction</span>

<span class="sd">    :return:</span>
<span class="sd">        x_train: This is the returned train dataset</span>
<span class="sd">        x_test: This is the returned test dataset</span>
<span class="sd">        y_train: This is the returned training label</span>
<span class="sd">        y_test: This is the returned testing label</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># assign a random float from 0~1 to each row with uniform distribution</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="o">.</span><span class="mi">75</span>
    <span class="c1"># label encoding, map each categorical data to a coresponding number</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;iso3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">factorize</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;iso3&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1"># detemine trani and test set, True = training set and False = test set</span>
    <span class="n">train</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">]</span>
    <span class="n">test</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">]</span>
    <span class="c1"># dataset and feature splitting for training nd testing</span>
    <span class="n">x_train</span> <span class="o">=</span> <span class="n">train</span><span class="p">[</span><span class="n">features</span><span class="p">]</span>
    <span class="n">x_test</span> <span class="o">=</span> <span class="n">test</span><span class="p">[</span><span class="n">features</span><span class="p">]</span>
    <span class="n">y_train</span> <span class="o">=</span> <span class="n">train</span><span class="p">[</span><span class="n">LABEL</span> <span class="o">+</span> <span class="s1">&#39;_rank&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">y_test</span> <span class="o">=</span> <span class="n">test</span><span class="p">[</span><span class="n">LABEL</span> <span class="o">+</span> <span class="s1">&#39;_rank&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x_train</span><span class="p">,</span> <span class="n">x_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span></div>
</pre></div>

                </div>
              </div>

            </div>

            <div class="clearer"></div>
          </div>
        </div>

        <div class="bottomnav">
          
        <p>
        <a class="uplink" href="../index.html">Contents</a>
        </p>

        </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2018, Adrien Allorant, Ruofan Cai, Joseph Frostad, Kevin Hsu, Tianyi Li.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.2.
    </div>
  </body>
</html>